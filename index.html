<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Block Puzzle</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #111;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
        }
        .game-container {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            color: white;
            font-family: Arial, sans-serif;
            width: 80px;
            height: 400px;
        }
        .next-piece-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #next-piece {
            background: #000;
            border: 1px solid #333;
        }
        .speed-container {
            font-size: 11px;
            margin-top: 8px;
        }
        .speed-container select {
            font-size: 11px;
            padding: 2px;
            width: 100%;
        }
        .score-container {
            font-size: 12px;
            margin-top: auto;
            padding-bottom: 5px;
        }
        .score-container div {
            margin: 2px 0;
        }
        #score {
            font-weight: bold;
            font-size: 14px;
        }
        #game {
            display: block;
        }
        .controls-container {
            display: none;
            width: 100%;
            max-width: 320px;
            margin-top: 15px;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 5px 0;
        }
        .control-btn {
            width: 70px;
            height: 60px;
            font-size: 28px;
            border: none;
            border-radius: 10px;
            background: #333;
            color: white;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-btn:active {
            background: #555;
            transform: scale(0.95);
        }
        .control-btn.rotate {
            background: #4b4bff;
        }
        .control-btn.drop {
            background: #ff4b4b;
            width: 150px;
        }
        /* Name modal */
        .modal-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal {
            background: #222;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            color: white;
            font-family: Arial, sans-serif;
        }
        .modal h2 {
            margin: 0 0 20px 0;
            font-size: 24px;
        }
        .modal input {
            font-size: 18px;
            padding: 10px;
            width: 200px;
            border: none;
            border-radius: 5px;
            text-align: center;
        }
        .modal button {
            margin-top: 15px;
            padding: 10px 30px;
            font-size: 18px;
            background: #4b4bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal button:hover {
            background: #6b6bff;
        }
        /* Photo celebration overlay */
        .photo-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            justify-content: center;
            align-items: center;
            z-index: 200;
            flex-direction: column;
        }
        .photo-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        .photo-overlay img {
            max-width: 90%;
            max-height: 70%;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255,255,255,0.3);
        }
        .photo-overlay .blocks-text {
            color: #ffff4b;
            font-size: 48px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            text-shadow: 0 0 20px #ffff4b;
            margin-bottom: 20px;
            animation: pulse 0.5s ease infinite alternate;
        }
        .photo-overlay .close-hint {
            color: #888;
            font-size: 14px;
            font-family: Arial, sans-serif;
            margin-top: 20px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        @media (max-width: 600px) {
            .controls-container {
                display: block;
            }
        }
        @media (max-height: 700px) and (max-width: 600px) {
            #game {
                max-height: 300px;
                width: auto;
            }
            .sidebar {
                height: 300px;
            }
            .control-btn {
                height: 50px;
                width: 60px;
            }
            .control-btn.drop {
                width: 130px;
            }
        }
    </style>
</head>
<body>

<!-- NAME MODAL -->
<div id="name-modal" class="modal-overlay">
    <div class="modal">
        <h2>Block Puzzle</h2>
        <input id="player-name" type="text" maxlength="10" placeholder="Your name">
        <br>
        <button id="start-btn">Start Game</button>
    </div>
</div>

<!-- PHOTO CELEBRATION OVERLAY -->
<div id="photo-overlay" class="photo-overlay">
    <div class="blocks-text">BLOCKS!</div>
    <img id="celebration-photo" src="" alt="Celebration">
    <div class="close-hint">Click anywhere or press any key to continue</div>
</div>

<!-- SPEL -->
<div class="game-container">
    <!-- Sidebar links -->
    <div class="sidebar">
        <div class="next-piece-container">
            <canvas id="next-piece" width="80" height="80"></canvas>
        </div>
        <div class="speed-container">
            <select id="speed">
                <option value="800">Slow</option>
                <option value="500">Normal</option>
                <option value="300">Fast</option>
                <option value="150">Very Fast</option>
            </select>
        </div>
        <div class="score-container">
            <div id="score">0</div>
            <div id="topscore">Top: 0</div>
        </div>
    </div>

    <!-- Main game -->
    <div style="position:relative;">
        <canvas id="game" width="240" height="400" style="background:#000; border:1px solid #333;"></canvas>
        <div id="gameover" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); flex-direction:column; justify-content:center; align-items:center; color:white; font-family:Arial;">
            <div style="font-size:32px; font-weight:bold; color:#ff4b4b; margin-bottom:20px;">GAME OVER</div>
            <div style="font-size:18px; margin-bottom:10px;">Final Score: <span id="final-score">0</span></div>
            <div id="new-highscore" style="font-size:16px; color:#4bff4b; margin-bottom:15px; display:none;">New High Score!</div>
            <div id="highscore-display" style="font-size:14px; color:#ffff4b; margin-bottom:20px; padding:10px; background:rgba(255,255,255,0.1); border-radius:5px;">
                High Score: <span id="highscore-name">---</span> - <span id="highscore-value">0</span>
            </div>
            <button id="restart-btn" style="padding:10px 30px; font-size:18px; cursor:pointer; background:#4b4bff; color:white; border:none; border-radius:5px;">Play Again</button>
            <div style="font-size:12px; margin-top:15px; color:#888;">Press SPACE to restart</div>
        </div>
    </div>
</div>

<!-- MOBILE TOUCH CONTROLS -->
<div class="controls-container" id="touch-controls">
    <div class="control-row">
        <button class="control-btn rotate" id="btn-rotate">↻</button>
    </div>
    <div class="control-row">
        <button class="control-btn" id="btn-left">←</button>
        <button class="control-btn drop" id="btn-drop">↓ DROP</button>
        <button class="control-btn" id="btn-right">→</button>
    </div>
</div>

<script>
// ---------------- GAME STATE ----------------
let gameOver = false;
let gameStarted = false;

// ---------------- SCORE ----------------
let score = 0;
let topscore = parseInt(localStorage.getItem("blocks_topscore") || "0");
let topscoreName = localStorage.getItem("blocks_topscore_name") || "---";

// Player name handling
const playerNameInput = document.getElementById("player-name");
const nameModal = document.getElementById("name-modal");
const startBtn = document.getElementById("start-btn");

// Initialize player name from localStorage
playerNameInput.value = localStorage.getItem("blocks_player_name") || "";

function getPlayerName() {
    return playerNameInput.value.trim() || "Anonymous";
}

function updateScoreDisplay() {
    document.getElementById("score").innerText = score;
    document.getElementById("topscore").innerText = "Top: " + topscore;
}

// Start game when button clicked
startBtn.addEventListener("click", startGame);
playerNameInput.addEventListener("keypress", e => {
    if (e.key === "Enter") startGame();
});

function startGame() {
    const name = playerNameInput.value.trim();
    if (name) {
        localStorage.setItem("blocks_player_name", name);
    }
    nameModal.style.display = "none";
    gameStarted = true;
    playerReset();
    update();
    updateScoreDisplay();
}

function addScore(rows) {
    score += rows * 100;
    if (score > topscore) {
        topscore = score;
        topscoreName = getPlayerName();
        localStorage.setItem("blocks_topscore", topscore);
        localStorage.setItem("blocks_topscore_name", topscoreName);
    }
    updateScoreDisplay();
}

// ---------------- GAME OVER ----------------
function showGameOver() {
    gameOver = true;
    const isNewHighScore = score > 0 && score >= topscore;

    // If new high score, update with current player name
    if (isNewHighScore) {
        topscore = score;
        topscoreName = getPlayerName();
        localStorage.setItem("blocks_topscore", topscore);
        localStorage.setItem("blocks_topscore_name", topscoreName);
        updateScoreDisplay();
    }

    document.getElementById("final-score").innerText = score;
    document.getElementById("new-highscore").style.display = isNewHighScore ? "block" : "none";
    document.getElementById("highscore-name").innerText = topscoreName;
    document.getElementById("highscore-value").innerText = topscore;
    document.getElementById("gameover").style.display = "flex";
}

function restartGame() {
    gameOver = false;
    score = 0;
    updateScoreDisplay();
    arena.forEach(row => row.fill(0));
    document.getElementById("gameover").style.display = "none";
    nextPiece = null;  // Reset next piece queue
    playerReset();
}

// ---------------- GELUID ----------------
const audio = new (window.AudioContext || window.webkitAudioContext)();

function playBeep(freq = 440, duration = 0.08, type="square", volume=0.15) {
    const osc = audio.createOscillator();
    const gain = audio.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.value = volume;
    osc.connect(gain);
    gain.connect(audio.destination);
    osc.start();
    osc.stop(audio.currentTime + duration);
}

const SFX = {
    move: () => playBeep(300, 0.05, "square", 0.08),
    rotate: () => playBeep(500, 0.06, "sawtooth", 0.1),
    drop: () => playBeep(120, 0.12, "square", 0.15),
    clear: () => playBeep(700, 0.25, "triangle", 0.25),
    gameover: () => playBeep(80, 0.6, "sine", 0.3),
    hardDrop: () => {
        // Impactful slam sound with quick decay
        playBeep(80, 0.15, "square", 0.4);
        setTimeout(() => playBeep(60, 0.1, "square", 0.2), 30);
    },
    blocks: () => {
        // Special celebratory sound for 4-line clear
        playBeep(523, 0.15, "triangle", 0.3);
        setTimeout(() => playBeep(659, 0.15, "triangle", 0.3), 100);
        setTimeout(() => playBeep(784, 0.15, "triangle", 0.3), 200);
        setTimeout(() => playBeep(1047, 0.3, "triangle", 0.4), 300);
    },
};

// ---------------- PHOTO CELEBRATION ----------------
const photoOverlay = document.getElementById("photo-overlay");
const celebrationPhoto = document.getElementById("celebration-photo");
let photoShowing = false;

function showRandomPhoto() {
    // Use Lorem Picsum for random photos with cache-busting
    const randomId = Math.floor(Math.random() * 1000);
    celebrationPhoto.src = `https://picsum.photos/600/400?random=${randomId}&t=${Date.now()}`;
    photoOverlay.classList.add("show");
    photoShowing = true;
    SFX.blocks();
}

function hidePhoto() {
    if (!photoShowing) return;
    photoOverlay.classList.remove("show");
    photoShowing = false;
}

// Close photo on click
photoOverlay.addEventListener("click", hidePhoto);

// Close photo on any key press
document.addEventListener("keydown", (e) => {
    if (photoShowing) {
        e.preventDefault();
        hidePhoto();
    }
});

// ---------------- CANVAS ----------------
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.scale(20, 20);

// Next piece preview canvas
const nextCanvas = document.getElementById("next-piece");
const nextCtx = nextCanvas.getContext("2d");
nextCtx.scale(20, 20);

const arena = createMatrix(12, 20);

// Next piece tracking
let nextPiece = null;
let nextColor = 1;

const colors = [
  null,
  "#ff4b4b", "#4bff4b", "#4b4bff",
  "#ffff4b", "#4bffff", "#ff4bff", "#ffffff",
];

// ---------------- PIECES ----------------
function createPiece(type) {
  if (type === "T") return [[0,1,0],[1,1,1],[0,0,0]];
  if (type === "O") return [[1,1],[1,1]];
  if (type === "L") return [[0,0,1],[1,1,1],[0,0,0]];
  if (type === "J") return [[1,0,0],[1,1,1],[0,0,0]];
  if (type === "I") return [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]];
  if (type === "S") return [[0,1,1],[1,1,0],[0,0,0]];
  if (type === "Z") return [[1,1,0],[0,1,1],[0,0,0]];
}

function createMatrix(w,h){
    const m=[]; while(h--) m.push(new Array(w).fill(0));
    return m;
}

function collide(arena,player){
  const [m,o]=[player.matrix,player.pos];
  for(let y=0;y<m.length;y++){
    for(let x=0;x<m[y].length;x++){
      if(m[y][x]!==0 &&
        (arena[y+o.y] && arena[y+o.y][x+o.x]) !== 0){
        return true;
      }
    }
  }
  return false;
}

function merge(arena,player){
  player.matrix.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v!==0) arena[y+player.pos.y][x+player.pos.x]=player.color;
    });
  });
}

function draw(){
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  arena.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v!==0){
        ctx.fillStyle=colors[v];
        ctx.fillRect(x,y,1,1);
      }
    });
  });

  drawMatrix(player.matrix,player.pos,colors[player.color]);
}

function drawMatrix(matrix,offset,color){
  matrix.forEach((row,y)=>{
    row.forEach((v,x)=>{
      if(v!==0){
        ctx.fillStyle=color;
        ctx.fillRect(x+offset.x,y+offset.y,1,1);
      }
    });
  });
}

function drawNextPiece(){
  nextCtx.fillStyle="#000";
  nextCtx.fillRect(0,0,4,4);

  if(nextPiece){
    const offsetX = (4 - nextPiece[0].length) / 2;
    const offsetY = (4 - nextPiece.length) / 2;
    nextPiece.forEach((row,y)=>{
      row.forEach((v,x)=>{
        if(v!==0){
          nextCtx.fillStyle=colors[nextColor];
          nextCtx.fillRect(x+offsetX,y+offsetY,1,1);
        }
      });
    });
  }
}

function rotate(matrix,dir){
  for(let y=0;y<matrix.length;y++){
    for(let x=0;x<y;x++){
      [matrix[x][y],matrix[y][x]]=[matrix[y][x],matrix[x][y]];
    }
  }
  if(dir>0)matrix.forEach(r=>r.reverse());
  else matrix.reverse();
}

function getRandomPiece(){
  const pieces="TJLOSZI";
  return {
    matrix: createPiece(pieces[Math.floor(Math.random()*7)]),
    color: Math.floor(Math.random()*7)+1
  };
}

function playerReset(){
  // Use next piece if available, otherwise generate new one
  if(nextPiece){
    player.matrix = nextPiece;
    player.color = nextColor;
  } else {
    const piece = getRandomPiece();
    player.matrix = piece.matrix;
    player.color = piece.color;
  }

  // Generate next piece
  const next = getRandomPiece();
  nextPiece = next.matrix;
  nextColor = next.color;
  drawNextPiece();

  player.pos.y=0;
  player.pos.x=(arena[0].length/2|0)-(player.matrix[0].length/2|0);

  if(collide(arena,player)){
    SFX.gameover();
    showGameOver();
  }
}

function arenaSweep(){
  let rows = 0;

  for(let y=arena.length-1;y>=0;y--){
    if(arena[y].every(v=>v!==0)){
      arena.splice(y,1);
      arena.unshift(new Array(12).fill(0));
      rows++;
      y++;
    }
  }
  if(rows>0){
    addScore(rows);
    if(rows === 4){
      // BLOCKS! Show random photo celebration
      showRandomPhoto();
    } else {
      SFX.clear();
    }
  }
}

let dropCounter=0;
let lastTime=0;
let dropInterval = parseInt(localStorage.getItem("blocks_speed") || "500");

// Initialize speed dropdown from saved preference
const speedSelect = document.getElementById("speed");
speedSelect.value = dropInterval.toString();

speedSelect.addEventListener("change", e => {
    dropInterval = parseInt(e.target.value);
    localStorage.setItem("blocks_speed", dropInterval);
});

const player={
  pos:{x:5,y:0},
  matrix:null,
  color:1,
};

function update(t=0){
  if(!gameStarted || gameOver){
    requestAnimationFrame(update);
    return;
  }

  const dt=t-lastTime; lastTime=t;
  dropCounter+=dt;

  if(dropCounter>dropInterval){
    player.pos.y++;
    if(collide(arena,player)){
      player.pos.y--;
      merge(arena,player);
      SFX.drop();
      arenaSweep();
      playerReset();
    }
    dropCounter=0;
  }

  draw();
  requestAnimationFrame(update);
}

// ---------------- INPUT ----------------
document.addEventListener("keydown",e=>{
  if(e.key===" " && gameOver){
    restartGame();
    return;
  }
  if(gameOver) return;

  if(e.key===" "){
    hardDrop();
    return;
  }
  if(e.key==="ArrowLeft"){
    player.pos.x--;
    if(collide(arena,player))player.pos.x++;
    else SFX.move();
  }
  if(e.key==="ArrowRight"){
    player.pos.x++;
    if(collide(arena,player))player.pos.x--;
    else SFX.move();
  }
  if(e.key==="ArrowDown"){
    player.pos.y++;
    if(collide(arena,player))player.pos.y--;
    else SFX.move();
  }
  if(e.key==="ArrowUp"){
    const old=JSON.parse(JSON.stringify(player.matrix));
    rotate(player.matrix,1);
    if(collide(arena,player))player.matrix=old;
    else SFX.rotate();
  }
});

// Restart button click handler
document.getElementById("restart-btn").addEventListener("click", restartGame);

// ---------------- MOBILE TOUCH CONTROLS ----------------
function moveLeft() {
    if(gameOver) return;
    player.pos.x--;
    if(collide(arena, player)) player.pos.x++;
    else SFX.move();
}

function moveRight() {
    if(gameOver) return;
    player.pos.x++;
    if(collide(arena, player)) player.pos.x--;
    else SFX.move();
}

function moveDown() {
    if(gameOver) return;
    player.pos.y++;
    if(collide(arena, player)) player.pos.y--;
    else SFX.move();
}

function hardDrop() {
    if(gameOver) return;
    // Move piece down until collision
    while(!collide(arena, player)) {
        player.pos.y++;
    }
    player.pos.y--;
    // Lock the piece
    merge(arena, player);
    SFX.hardDrop();
    arenaSweep();
    playerReset();
    dropCounter = 0;
}

function rotatePiece() {
    if(gameOver) return;
    const old = JSON.parse(JSON.stringify(player.matrix));
    rotate(player.matrix, 1);
    if(collide(arena, player)) player.matrix = old;
    else SFX.rotate();
}

// Touch button handlers
const btnLeft = document.getElementById("btn-left");
const btnRight = document.getElementById("btn-right");
const btnDrop = document.getElementById("btn-drop");
const btnRotate = document.getElementById("btn-rotate");

// Prevent default to avoid scrolling and double-fire
function addTouchHandler(element, handler) {
    let intervalId = null;

    const startAction = (e) => {
        e.preventDefault();
        // Resume audio context on user interaction (required for mobile)
        if(audio.state === 'suspended') audio.resume();
        handler();
        // Repeat action for held buttons (except rotate)
        if(element !== btnRotate) {
            intervalId = setInterval(handler, 100);
        }
    };

    const stopAction = (e) => {
        e.preventDefault();
        if(intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        }
    };

    element.addEventListener("touchstart", startAction, { passive: false });
    element.addEventListener("touchend", stopAction, { passive: false });
    element.addEventListener("touchcancel", stopAction, { passive: false });

    // Also support mouse for testing
    element.addEventListener("mousedown", startAction);
    element.addEventListener("mouseup", stopAction);
    element.addEventListener("mouseleave", stopAction);
}

addTouchHandler(btnLeft, moveLeft);
addTouchHandler(btnRight, moveRight);
addTouchHandler(btnRotate, rotatePiece);

// Hard drop button - single press only, no repeat
btnDrop.addEventListener("touchstart", (e) => {
    e.preventDefault();
    if(audio.state === 'suspended') audio.resume();
    hardDrop();
}, { passive: false });
btnDrop.addEventListener("mousedown", (e) => {
    e.preventDefault();
    hardDrop();
});

// Resume AudioContext on first user interaction (required for mobile browsers)
document.addEventListener("touchstart", function resumeAudio() {
    if(audio.state === 'suspended') {
        audio.resume();
    }
    document.removeEventListener("touchstart", resumeAudio);
}, { once: true });

document.addEventListener("click", function resumeAudioClick() {
    if(audio.state === 'suspended') {
        audio.resume();
    }
    document.removeEventListener("click", resumeAudioClick);
}, { once: true });

// Don't auto-start - wait for name modal
updateScoreDisplay();
</script>
</body>
</html>
